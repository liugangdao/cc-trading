# 需求文档

## 简介

本功能为交易日志CLI系统在开仓流程中添加市场背景记录能力。在开仓时询问用户当前是否处于牛市，如果是牛市则进一步询问三个牛市末期确认条件，当满足两个或以上条件时标记为"牛市末期"并记录备注。市场背景信息将与仓位一起存储，便于后续分析和风险评估。

## 术语表

- **系统**: 交易日志CLI系统
- **市场背景**: 开仓时记录的市场状态，包括是否牛市及牛市末期判断
- **牛市末期**: 满足2个或以上牛市末期确认条件的状态
- **EMA20**: 20日指数移动平均线
- **仓位**: Position结构体，存储交易信息

## 需求

### 需求 1: 市场背景数据模型

**用户故事**: 作为系统开发者，我需要在Position结构体中添加市场背景字段，以便在开仓时记录市场状态。

#### 验收标准

1. 系统应当在Position结构体中添加IsBullMarket布尔字段，表示开仓时是否为牛市
2. 系统应当在Position结构体中添加BullMarketEndSignal1布尔字段，表示"日线跌破EMA20并反抽失败"
3. 系统应当在Position结构体中添加BullMarketEndSignal2布尔字段，表示"创新高但成交量明显低于前高"
4. 系统应当在Position结构体中添加BullMarketEndSignal3布尔字段，表示"连续两次回调都打穿前低"
5. 系统应当在Position结构体中添加MarketContextNote字符串字段，用于存储市场背景备注

### 需求 2: 开仓时市场背景询问

**用户故事**: 作为交易者，我需要在开仓时被询问市场背景，以便记录当前市场状态。

#### 验收标准

1. 当用户执行开仓命令并输入基本信息后，系统应当询问"当前是否为牛市？(y/n)"
2. 当用户回答"否"时，系统应当跳过牛市末期条件询问，继续开仓流程
3. 当用户回答"是"时，系统应当继续询问三个牛市末期确认条件
4. 当询问牛市末期条件时，系统应当显示条件1："日线是否跌破EMA20并反抽失败？(y/n)"
5. 当询问牛市末期条件时，系统应当显示条件2："创新高但成交量明显低于前高？(y/n)"
6. 当询问牛市末期条件时，系统应当显示条件3："连续两次回调都打穿前低？(y/n)"
7. 当三个条件询问完毕后，系统应当询问"市场背景备注："并允许用户输入可选备注

### 需求 3: 牛市末期判断和提示

**用户故事**: 作为交易者，我需要系统自动判断是否为牛市末期，以便及时了解风险。

#### 验收标准

1. 当满足2个或以上牛市末期条件时，系统应当在开仓确认前显示"⚠️ 警告：当前处于牛市末期"
2. 当满足全部3个牛市末期条件时，系统应当显示"🚨 严重警告：满足全部牛市末期信号，建议只减仓不加仓"
3. 当显示警告后，系统应当询问用户是否继续开仓
4. 当用户选择取消时，系统应当终止开仓流程
5. 当用户选择继续时，系统应当完成开仓并保存市场背景信息


### 需求 4: 仓位列表中显示市场背景

**用户故事**: 作为交易者，我需要在查看仓位列表时看到市场背景信息，以便快速评估风险。

#### 验收标准

1. 当用户查看持仓列表时，如果仓位开仓时标记为牛市，系统应当在该行显示"牛市"标记
2. 当仓位满足2个牛市末期条件时，系统应当显示"牛市末期"标记
3. 当仓位满足全部3个牛市末期条件时，系统应当用醒目颜色显示"牛市末期(3/3)"
4. 当用户查看仓位详情时，系统应当显示完整的市场背景信息，包括三个条件的具体状态
5. 当市场背景备注不为空时，系统应当在仓位详情中显示备注内容

### 需求 5: 市场背景数据持久化

**用户故事**: 作为系统，我需要将市场背景信息与仓位一起存储到JSONL文件，以便数据持久化。

#### 验收标准

1. 当保存仓位到JSONL文件时，系统应当包含所有市场背景字段
2. 当从JSONL文件读取仓位时，系统应当正确解析市场背景字段
3. 当市场背景字段不存在时（旧数据），系统应当将其设置为默认值（false和空字符串）
4. 系统应当保持与现有JSONL存储格式的兼容性
