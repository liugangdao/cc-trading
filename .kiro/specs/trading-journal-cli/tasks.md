# 实施计划：交易日志系统

## 概述

实现一个基于 Claude Code 对话的交易记录和管理系统。用户通过自然语言与 Claude Code 交互，系统使用 Go 代码处理数据，采用 JSONL 文件存储。实施将按照增量方式进行，每个任务构建在前一个任务之上，确保核心功能尽早通过代码验证。

## 任务列表

- [ ] 1. 设置项目结构和核心数据模型
  - 创建目录结构（internal/models, internal/storage, internal/validator, internal/operations）
  - 创建 trading-data 目录用于存储 JSONL 文件
  - 定义 Position 结构体，包含所有必需字段
  - 定义常量类型（Direction, MarketType, Status, CloseReason）
  - 实现 GeneratePositionID 函数（格式：YYYYMMDD-HHMMSS-XXXX）
  - _需求: 2.1.2, 3.1, 3.2_

- [ ]* 1.1 为仓位 ID 生成编写属性测试
  - **Property 1: 仓位 ID 唯一性**
  - **验证需求: 2.1.2**

- [ ] 2. 实现数据验证逻辑
  - [ ] 2.1 实现 PositionValidator 结构体
    - 实现 ValidateOpenPosition 方法
    - 验证必填字段（symbol, openPrice, quantity, stopLoss, takeProfit, margin）
    - 验证价格和数量为正数
    - 验证止损止盈范围（做多：止损 < 开仓价 < 止盈；做空：止盈 < 开仓价 < 止损）
    - 定义所有验证错误类型
    - _需求: 2.1.3, 3.1_
  
  - [ ]* 2.2 为止损止盈验证编写属性测试
    - **Property 2: 止损止盈必填验证**
    - **Property 11: 止损止盈范围验证**
    - **验证需求: 2.1.3**
  
  - [ ] 2.3 实现 ValidateClosePosition 方法
    - 验证仓位状态（必须是 open）
    - 验证平仓价格为正数
    - 验证平仓数量不超过持仓数量
    - _需求: 2.2.4, 2.2.5_
  
  - [ ]* 2.4 为平仓验证编写属性测试
    - **Property 7: 部分平仓数量**
    - **验证需求: 2.2.5**

- [ ] 3. 实现 JSONL 存储层
  - [ ] 3.1 实现 JSONLStorage 结构体
    - 实现 AppendPosition 方法（追加记录到月度文件）
    - 实现文件命名逻辑（trades-YYYY-MM.jsonl）
    - 确保数据目录存在（自动创建）
    - 处理 JSON 序列化错误
    - _需求: 2.1.5, 3.3_
  
  - [ ]* 3.2 为月度文件存储编写属性测试
    - **Property 4: 按月份存储**
    - **验证需求: 2.1.5**
  
  - [ ] 3.3 实现读取方法
    - 实现 ReadPositions 方法（读取指定月份）
    - 实现 ReadAllPositions 方法（读取所有月份）
    - 实现 ReadOpenPositions 方法（筛选未平仓）
    - 处理同一 positionId 的多个版本（取最后一条）
    - 处理 JSON 解析错误（跳过损坏的行）
    - _需求: 2.2.1, 2.3.1, 2.3.2_
  
  - [ ]* 3.4 为 JSONL 序列化编写属性测试
    - **Property 9: 序列化往返一致性**
    - **验证需求: 3.3**
  
  - [ ] 3.5 实现 UpdatePosition 方法
    - 追加更新后的记录到文件
    - 保留历史版本（审计追踪）
    - _需求: 2.2.4_
  
  - [ ]* 3.6 为仓位查找编写属性测试
    - **Property 5: 仓位 ID 查找**
    - **验证需求: 2.2.2**

- [ ] 4. 检查点 - 确保存储层测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 5. 实现开仓操作
  - [ ] 5.1 实现 OpenPosition 函数
    - 接收 OpenParams 参数
    - 创建 Position 对象
    - 设置开仓时间（使用当前时间）
    - 生成唯一仓位 ID
    - 调用验证器验证数据
    - 调用存储层保存记录
    - 返回创建的 Position 对象
    - _需求: 2.1, 3.4.1_
  
  - [ ]* 5.2 为市场类型支持编写属性测试
    - **Property 3: 市场类型支持**
    - **验证需求: 2.1.4**
  
  - [ ]* 5.3 编写开仓操作的单元测试
    - 测试成功开仓场景
    - 测试验证失败场景
    - 测试存储失败场景
    - _需求: 2.1_

- [ ] 6. 实现平仓操作
  - [ ] 6.1 实现盈亏计算函数
    - 实现 CalculateRealizedPnL 函数（根据方向计算）
    - 实现 CalculatePnLPercentage 函数
    - 实现 CalculateHoldingDuration 函数（格式化为可读字符串）
    - _需求: 2.2.3, 3.2_
  
  - [ ]* 6.2 为盈亏计算编写属性测试
    - **Property 10: 盈亏计算正确性**
    - **验证需求: 2.2.3**
  
  - [ ] 6.3 实现 ClosePosition 函数
    - 接收 positionID 和 CloseParams 参数
    - 查找指定的仓位
    - 验证仓位状态（必须是 open）
    - 验证平仓数据
    - 设置平仓时间（使用当前时间）
    - 计算盈亏和持仓时长
    - 更新仓位状态为 closed
    - 调用存储层更新记录
    - 返回更新后的 Position 对象
    - _需求: 2.2, 3.4.2_
  
  - [ ]* 6.4 为平仓完整性编写属性测试
    - **Property 6: 平仓完整性**
    - **验证需求: 2.2.3, 2.2.4**
  
  - [ ]* 6.5 编写平仓操作的单元测试
    - 测试成功平仓场景
    - 测试部分平仓场景
    - 测试仓位不存在场景
    - 测试仓位已平仓场景
    - _需求: 2.2_

- [ ] 7. 实现查询和筛选操作
  - [ ] 7.1 实现 ListPositions 函数
    - 接收 FilterParams 参数
    - 根据 status 筛选（open, closed, all）
    - 根据 symbol 筛选
    - 根据 marketType 筛选
    - 根据日期范围筛选
    - 返回筛选后的仓位列表
    - _需求: 2.3, 3.4.3_
  
  - [ ]* 7.2 为筛选功能编写属性测试
    - **Property 8: 筛选准确性**
    - **验证需求: 2.2.1, 2.3.2, 2.3.3**
  
  - [ ]* 7.3 编写查询操作的单元测试
    - 测试各种筛选条件组合
    - 测试空结果场景
    - 测试跨月份查询
    - _需求: 2.3_

- [ ] 8. 实现分析功能
  - [ ] 8.1 实现 AnalyzeRisk 函数
    - 读取所有未平仓位
    - 计算总保证金
    - 计算最大可能损失（所有止损触发）
    - 计算每个仓位的风险回报比
    - 统计仓位集中度（按市场类型和品种）
    - 返回 RiskReport 结构体
    - _需求: 2.4_
  
  - [ ] 8.2 实现 AnalyzePerformance 函数
    - 读取历史交易（根据 AnalysisParams）
    - 计算总交易次数和胜率
    - 计算平均盈亏比
    - 按品种和市场类型统计表现
    - 统计平仓原因分布
    - 分析持仓时长与盈亏关系
    - 返回 PerformanceReport 结构体
    - _需求: 2.5_
  
  - [ ]* 8.3 编写分析功能的单元测试
    - 测试风险分析计算
    - 测试表现分析计算
    - 测试空数据场景
    - _需求: 2.4, 2.5_

- [ ] 9. 检查点 - 确保所有核心功能测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 10. 创建使用示例和文档
  - [ ] 10.1 创建 README.md
    - 说明系统概述和使用方式
    - 提供对话交互示例
    - 说明数据存储位置和格式
    - 提供常见问题解答
  
  - [ ] 10.2 创建示例对话脚本
    - 开仓示例（多个市场类型）
    - 平仓示例（完全平仓和部分平仓）
    - 查询示例（各种筛选条件）
    - 分析示例（风险和表现）
  
  - [ ] 10.3 创建数据格式文档
    - 说明 JSONL 文件格式
    - 提供完整的 Position 结构示例
    - 说明文件命名规则

- [ ] 11. 最终检查点 - 完整功能验证
  - 运行所有测试（单元测试和属性测试）
  - 验证所有正确性属性
  - 确认错误处理正常工作
  - 如有问题请询问用户

## 注意事项

- 标记 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
